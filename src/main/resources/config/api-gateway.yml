# API Gateway Service Configuration

server:
  port: ${API_GATEWAY_PORT:9191}

spring:
  cloud:
    gateway:
      # Global CORS Configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins:
              - ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:8081}
            allowed-methods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            allowed-headers:
              - "*"
            allow-credentials: true
            max-age: 3600
      
      # Default Filters
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
        - name: RequestRateLimiter
          args:
            redis-rate-limiter.replenishRate: 100
            redis-rate-limiter.burstCapacity: 200
        - name: CircuitBreaker
          args:
            name: defaultCircuitBreaker
            fallbackUri: forward:/fallback
      
      # Service Discovery with Load Balancing
      discovery:
        locator:
          enabled: true
          lower-case-service-id: false
      
      # Route Definitions
      routes:
        # User Auth Service Routes
        - id: mobile-user-auth-service
          uri: lb://MOBILE-USER-AUTH-SERVICE
          predicates:
            - Path=/api/auth/**,/api/users/**,/api/profile/**
          filters:
            - name: CircuitBreaker
              args:
                name: userAuthCircuitBreaker
                fallbackUri: forward:/fallback/auth
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
        
        # Patient Customer Service Routes
        - id: patient-customer-service
          uri: lb://PATIENT-CUSTOMER-SERVICE
          predicates:
            - Path=/api/customers/**,/api/prescriptions/**,/api/medical-records/**,/api/payments/**,/api/prescription-orders/**,/api/sub-customers/**
          filters:
            - name: CircuitBreaker
              args:
                name: customerServiceCircuitBreaker
                fallbackUri: forward:/fallback/customer
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
        
        # Branch Service Routes
        - id: branch-service
          uri: lb://BRANCH-SERVICE
          predicates:
            - Path=/lifepill/v1/branch/**,/lifepill/v1/employer/**
          filters:
            - name: CircuitBreaker
              args:
                name: branchServiceCircuitBreaker
                fallbackUri: forward:/fallback/branch
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
        
        # Inventory Service Routes
        - id: inventory-service
          uri: lb://INVENTORY-SERVICE
          predicates:
            - Path=/lifepill/v1/item/**,/lifepill/v1/category/**,/lifepill/v1/supplier/**,/lifepill/v1/supplier-company/**
          filters:
            - name: CircuitBreaker
              args:
                name: inventoryServiceCircuitBreaker
                fallbackUri: forward:/fallback/inventory
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
        
        # Swagger Documentation Routes
        - id: user-auth-swagger
          uri: lb://MOBILE-USER-AUTH-SERVICE
          predicates:
            - Path=/user-auth/v3/api-docs/**,/user-auth/swagger-ui/**
          filters:
            - RewritePath=/user-auth/(?<path>.*), /${path}
        
        # Patient Customer Service Swagger Routes
        - id: customer-service-swagger
          uri: lb://PATIENT-CUSTOMER-SERVICE
          predicates:
            - Path=/customer-service/v3/api-docs/**,/customer-service/swagger-ui/**
          filters:
            - RewritePath=/customer-service/(?<path>.*), /${path}
        
        # Branch Service Swagger Routes
        - id: branch-service-swagger
          uri: lb://BRANCH-SERVICE
          predicates:
            - Path=/branch-service/v3/api-docs/**,/branch-service/swagger-ui/**
          filters:
            - RewritePath=/branch-service/(?<path>.*), /${path}
        
        # Inventory Service Swagger Routes
        - id: inventory-service-swagger
          uri: lb://INVENTORY-SERVICE
          predicates:
            - Path=/inventory-service/v3/api-docs/**,/inventory-service/swagger-ui/**
          filters:
            - RewritePath=/inventory-service/(?<path>.*), /${path}

# Resilience4j Circuit Breaker Configuration
resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10000
        permitted-number-of-calls-in-half-open-state: 3
        register-health-indicator: true
    instances:
      userAuthCircuitBreaker:
        base-config: default
      customerServiceCircuitBreaker:
        base-config: default
      branchServiceCircuitBreaker:
        base-config: default
      inventoryServiceCircuitBreaker:
        base-config: default
      defaultCircuitBreaker:
        base-config: default
  
  timelimiter:
    configs:
      default:
        timeout-duration: 5s
    instances:
      userAuthCircuitBreaker:
        base-config: default
      customerServiceCircuitBreaker:
        base-config: default
      branchServiceCircuitBreaker:
        base-config: default
      inventoryServiceCircuitBreaker:
        base-config: default
